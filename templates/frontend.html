<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Station Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS einbinden (Leaflet = leichtgewichtige, open-source JS-Bibliothek für interaktive Karten), Karte styling -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS einbinden (Leaflet = leichtgewichtige, open-source JS-Bibliothek für interaktive Karten), Kartenfunktionen -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Karte layout, volle Höhe/Breite, abgerundete Ecken */
    #map {
      height: 100%;
      width: 100%;
      border-radius: 0.5rem;
    }
    /* Textzentrierung, Temperaturzellen, Jahreszeiten Spalten, jährliche und Jahr Spalten */
    .temperature-cell,
    .column-spring, .column-summer, .column-autumn, .column-winter, .column-annual, .column-year {
      text-align: center;
      vertical-align: middle;
    }
    /* Container in Zellen, flex, vertikal und horizontal zentriert */
    .cell-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    /* Minimalwerte: blau, Maximalwerte: rot */
    .temperature-min { color: blue; }
    .temperature-max { color: red; }
    /* Dotted-Line, trennt Min/Max in einer Zelle, Breite 50%, Margin */
    .dotted-line {
      border-bottom: 1px dotted black;
      width: 50%;
      margin: 4px 0;
    }
    /* Allgemeine Formatierung: Daten Min: blau, Daten Max: rot */
    .data-min { color: blue; }
    .data-max { color: red; }
    /* Elemente ausblenden, falls benötigt */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">
    <!-- Linke Hälfte: Eingabefelder und Karte, Parameter eingeben, Karte anzeigen -->
    <div class="w-1/2 p-4 flex flex-col space-y-4">
      <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold mb-4">Eingabeparameter</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="latitude" class="block text-sm font-medium">Breite</label>
            <input id="latitude" type="text" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label for="longitude" class="block text-sm font-medium">Länge</label>
            <input id="longitude" type="text" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label for="start-year" class="block text-sm font-medium">Startjahr</label>
            <input id="start-year" type="number" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label for="end-year" class="block text-sm font-medium">Endjahr</label>
            <input id="end-year" type="number" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label for="station-count" class="block text-sm font-medium">Anzahl der Wetterstationen</label>
            <input id="station-count" type="number" placeholder="z.B. 20" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label for="radius" class="block text-sm font-medium">Umkreis (km)</label>
            <div class="flex items-center space-x-2">
              <input id="radius-slider" type="range" min="1" max="100" value="10" class="flex-grow">
              <input id="radius-input" type="number" min="1" max="100" value="10" class="w-16 border rounded-lg p-2">
            </div>
          </div>
        </div>
        <div class="flex justify-center mt-4">
          <!-- Suchen-Button, startet den Suchvorgang -->
          <button id="search-button" class="px-6 py-2 bg-blue-500 text-white rounded-lg">Suchen</button>
        </div>
      </div>
      <!-- Kartenanzeige, Map Container -->
      <div class="flex-grow rounded-lg shadow-md">
        <div id="map"></div>
      </div>
    </div>

    <!-- Rechte Hälfte: Stationenliste und Daten-Tabelle, Filter, Pagination -->
    <div class="w-1/2 p-4 flex flex-col space-y-4">
      <div class="bg-white p-4 rounded-lg shadow-md flex flex-col space-y-2">
        <h2 class="text-lg font-semibold">Wetterstationen</h2>
        <!-- Dynamische Stationenliste (paginiert), wird per API gefüllt -->
        <ul id="station-list" class="space-y-1">
          <!-- Dynamische Stationenliste (paginiert) -->
        </ul>
        <div class="flex justify-center mt-2 space-x-4">
          <!-- Pagination: Vorherige Seite, Nächste Seite -->
          <button id="prev-button" class="px-4 py-2 bg-blue-500 text-white rounded-lg">←</button>
          <button id="next-button" class="px-4 py-2 bg-blue-500 text-white rounded-lg">→</button>
        </div>
      </div>
      <!-- Filter und Daten-Tabelle, Filter Checkboxen, Tabelle dynamisch befüllen -->
      <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold mb-4">Datenfilter und Tabelle</h2>
        <!-- Filter Checkboxen in ursprünglicher Reihenfolge, steuern Anzeige der Spalten -->
        <div class="grid grid-cols-4 grid-rows-2 gap-4 mb-4">
          <!-- Maximalwerte (initial aktiviert beim Suchen, Checkbox an/aus) -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-minmax-max" onchange="toggleMinMax('max', this)" checked>
            <span>Maximalwerte</span>
          </label>
          <!-- Checkbox "Jährlich", steuert Spalte "annual" -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-annual" onchange="toggleColumn('annual', this)">
            <span>Jährlich</span>
          </label>
          <!-- Checkbox für Sommer -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-summer" onchange="toggleColumn('summer', this)">
            <span>Sommer</span>
          </label>
          <!-- Checkbox für Winter -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-winter" onchange="toggleColumn('winter', this)">
            <span>Winter</span>
          </label>
          <!-- Minimalwerte (initial aktiviert, Checkbox an/aus) -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-minmax-min" onchange="toggleMinMax('min', this)" checked>
            <span>Minimalwerte</span>
          </label>
          <div></div>
          <!-- Checkbox für Herbst -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-autumn" onchange="toggleColumn('autumn', this)">
            <span>Herbst</span>
          </label>
          <!-- Checkbox für Frühling -->
          <label class="flex items-center space-x-2">
            <input type="checkbox" class="rounded" id="filter-spring" onchange="toggleColumn('spring', this)">
            <span>Frühling</span>
          </label>
        </div>
        <!-- Tabelle, Kopfzeile mit festen Spalten, dynamische Datenzeilen -->
        <div class="overflow-x-auto">
          <table class="w-full border">
            <thead class="bg-gray-100">
              <tr>
                <!-- Jahr Spalte, immer sichtbar -->
                <th class="border p-2 column-year">Jahr</th>
                <!-- Weitere Spalten: Jährlich, Frühling, Sommer, Herbst, Winter -->
                <th class="border p-2 column-annual">Jährlich</th>
                <th class="border p-2 column-spring">Frühling</th>
                <th class="border p-2 column-summer">Sommer</th>
                <th class="border p-2 column-autumn">Herbst</th>
                <th class="border p-2 column-winter">Winter</th>
              </tr>
            </thead>
            <tbody id="data-table-body">
              <!-- Dynamische Datenzeilen -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript: API-Aufrufe, Marker, Pagination, Filter-Reset, Validierung, neue Marker-Icons -->
  <script>
    // Synchronisation von Radius-Slider und Zahlenfeld, Slider Input verbinden
    const radiusSlider = document.getElementById('radius-slider');
    const radiusInput = document.getElementById('radius-input');
    radiusSlider.addEventListener('input', () => {
      radiusInput.value = radiusSlider.value;
    });
    radiusInput.addEventListener('input', () => {
      if (radiusInput.value >= radiusSlider.min && radiusInput.value <= radiusSlider.max) {
        radiusSlider.value = radiusInput.value;
      }
    });

    // Definition benutzerdefinierter Marker Icons, rot und blau, für eigene Position und Stationen
    var redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    var blueIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Karte initialisieren, setView, OSM Kacheln laden, maxZoom, Attribution
    var map = L.map('map').setView([51.505, -0.09], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Globale Variablen, Stationsergebnisse, Pagination (currentPage, pageSize), Marker Arrays, aktueller Standortmarker
    var allStations = [];
    var currentPage = 0;
    var pageSize = 5;
    var stationMarkers = [];
    var currentLocationMarker = null;

    // Entfernt alle Stationen Marker von der Karte, leere Marker Liste
    function clearStationMarkers() {
      stationMarkers.forEach(marker => {
        map.removeLayer(marker);
      });
      stationMarkers = [];
    }

    // Setzt alle Filter Checkboxen zurück, alle Filter werden unselected, wendet Toggle Funktion direkt an
    function resetFilters() {
      const filterIds = [
        'filter-annual', 'filter-summer', 'filter-winter',
        'filter-autumn', 'filter-spring',
        'filter-minmax-max', 'filter-minmax-min'
      ];
      filterIds.forEach(id => {
        const cb = document.getElementById(id);
        if (cb) {
          cb.checked = false;
          // Wende die jeweilige Toggle Funktion direkt an:
          if (id.startsWith('filter-minmax')) {
            const type = id.endsWith('max') ? 'max' : 'min';
            toggleMinMax(type, cb);
          } else {
            // Extrahiere den Spaltennamen aus der ID (z.B. "annual" bei filter-annual)
            const col = id.split('-')[1];
            toggleColumn(col, cb);
          }
        }
      });
    }

    // Validiert, ob erforderliche Eingaben (Breite, Länge, Startjahr, Endjahr) ausgefüllt sind, sonst Alert
    function validateInputs() {
      const latitude = document.getElementById('latitude').value.trim();
      const longitude = document.getElementById('longitude').value.trim();
      const startYear = document.getElementById('start-year').value.trim();
      const endYear = document.getElementById('end-year').value.trim();
      if (!latitude || !longitude || !startYear || !endYear) {
        alert("Bitte füllen Sie alle erforderlichen Felder aus: Breite, Länge, Startjahr und Endjahr.");
        return false;
      }
      return true;
    }

    // Aktualisiert die paginierte Stationenliste, zeigt current page an, fügt Click Event zum Laden von Stationendaten hinzu
    function displayStationPage() {
      var startIndex = currentPage * pageSize;
      var endIndex = startIndex + pageSize;
      var pageStations = allStations.slice(startIndex, endIndex);
      var stationList = document.getElementById('station-list');
      stationList.innerHTML = '';
      pageStations.forEach(station => {
        var li = document.createElement('li');
        li.className = 'p-2 border rounded-lg cursor-pointer hover:bg-gray-200';
        li.textContent = station.name + " (" + station.distance + " km)";
        li.dataset.stationId = station.id;
        li.addEventListener('click', function() {
          var startYear = document.getElementById('start-year').value;
          var endYear = document.getElementById('end-year').value;
          fetch(`/api/get_station_data/?station_id=${station.id}&start_year=${startYear}&end_year=${endYear}`)
            .then(response => response.json())
            .then(result => {
              if(result.error) {
                console.error(result.error);
                updateDataTable({ error: result.error });
              } else {
                updateDataTable(result);
              }
            })
            .catch(err => console.error(err));
        });
        stationList.appendChild(li);
      });
    }

    // Baut die Datentabelle auf, wendet Filter an, erstellt für jedes Jahr eine Zeile mit festen Spalten (Jahr, Jährlich, Frühling, Sommer, Herbst, Winter)
    function updateDataTable(data) {
      const tableBody = document.getElementById('data-table-body');
      tableBody.innerHTML = '';
      if(data.error) {
        tableBody.innerHTML = `<tr><td colspan="6">${data.error}</td></tr>`;
        return;
      }
      const annual = data.annual;
      const seasonal = data.seasonal;
      const years = Object.keys(annual).sort();
      years.forEach(year => {
        var tr = document.createElement('tr');

        // Spalte: Jahr (immer sichtbar)
        var tdYear = document.createElement('td');
        tdYear.className = 'border p-2 column-year';
        tdYear.innerHTML = `<div class="cell-content">${year}</div>`;
        tr.appendChild(tdYear);

        // Spalte: Jährlich, Daten (avg TMAX, avg TMIN), Anzeige N/A falls null
        var tdAnnual = document.createElement('td');
        tdAnnual.className = 'border p-2 column-annual';
        var annualTmax = annual[year].TMAX.avg !== null ? annual[year].TMAX.avg + "°C" : "N/A";
        var annualTmin = annual[year].TMIN.avg !== null ? annual[year].TMIN.avg + "°C" : "N/A";
        tdAnnual.innerHTML = `<div class="cell-content">
                                <span class="data-max">${annualTmax}</span>
                                <span class="dotted-line"></span>
                                <span class="data-min">${annualTmin}</span>
                              </div>`;
        tr.appendChild(tdAnnual);

        // Spalte: Frühling, Daten aus seasonal, TMAX, TMIN
        var tdSpring = document.createElement('td');
        tdSpring.className = 'border p-2 column-spring';
        var springTmax = seasonal[year].spring.TMAX !== null ? seasonal[year].spring.TMAX + "°C" : "N/A";
        var springTmin = seasonal[year].spring.TMIN !== null ? seasonal[year].spring.TMIN + "°C" : "N/A";
        tdSpring.innerHTML = `<div class="cell-content">
                                <span class="data-max">${springTmax}</span>
                                <span class="dotted-line"></span>
                                <span class="data-min">${springTmin}</span>
                              </div>`;
        tr.appendChild(tdSpring);

        // Spalte: Sommer, Daten aus seasonal
        var tdSummer = document.createElement('td');
        tdSummer.className = 'border p-2 column-summer';
        var summerTmax = seasonal[year].summer.TMAX !== null ? seasonal[year].summer.TMAX + "°C" : "N/A";
        var summerTmin = seasonal[year].summer.TMIN !== null ? seasonal[year].summer.TMIN + "°C" : "N/A";
        tdSummer.innerHTML = `<div class="cell-content">
                                <span class="data-max">${summerTmax}</span>
                                <span class="dotted-line"></span>
                                <span class="data-min">${summerTmin}</span>
                              </div>`;
        tr.appendChild(tdSummer);

        // Spalte: Herbst, Daten aus seasonal
        var tdAutumn = document.createElement('td');
        tdAutumn.className = 'border p-2 column-autumn';
        var autumnTmax = seasonal[year].autumn.TMAX !== null ? seasonal[year].autumn.TMAX + "°C" : "N/A";
        var autumnTmin = seasonal[year].autumn.TMIN !== null ? seasonal[year].autumn.TMIN + "°C" : "N/A";
        tdAutumn.innerHTML = `<div class="cell-content">
                                <span class="data-max">${autumnTmax}</span>
                                <span class="dotted-line"></span>
                                <span class="data-min">${autumnTmin}</span>
                              </div>`;
        tr.appendChild(tdAutumn);

        // Spalte: Winter, Daten aus seasonal
        var tdWinter = document.createElement('td');
        tdWinter.className = 'border p-2 column-winter';
        var winterTmax = seasonal[year].winter.TMAX !== null ? seasonal[year].winter.TMAX + "°C" : "N/A";
        var winterTmin = seasonal[year].winter.TMIN !== null ? seasonal[year].winter.TMIN + "°C" : "N/A";
        tdWinter.innerHTML = `<div class="cell-content">
                                <span class="data-max">${winterTmax}</span>
                                <span class="dotted-line"></span>
                                <span class="data-min">${winterTmin}</span>
                              </div>`;
        tr.appendChild(tdWinter);

        tableBody.appendChild(tr);
      });

      // Wende aktuell gesetzte Filter an (Spalten werden per Checkbox gesteuert)
      toggleColumn('annual', document.getElementById('filter-annual'));
      toggleColumn('spring', document.getElementById('filter-spring'));
      toggleColumn('summer', document.getElementById('filter-summer'));
      toggleColumn('autumn', document.getElementById('filter-autumn'));
      toggleColumn('winter', document.getElementById('filter-winter'));
    }

    // Beim Klick auf "Suchen": Eingaben validieren, Filter zurücksetzen, API-Aufruf zum Abrufen von Stationen, Marker setzen, Karte zentrieren, Stationenliste anzeigen
    document.getElementById('search-button').addEventListener('click', function() {
      if (!validateInputs()) return; // Validierung der erforderlichen Eingaben

      resetFilters(); // Alle Filter-Checkboxen zurücksetzen

      const latitude = document.getElementById('latitude').value;
      const longitude = document.getElementById('longitude').value;
      const radius = document.getElementById('radius-input').value;
      const stationCountInput = document.getElementById('station-count').value;
      const stationCountParam = stationCountInput ? stationCountInput : '';
      fetch(`/api/search_stations/?latitude=${latitude}&longitude=${longitude}&radius=${radius}&station_count=${stationCountParam}`)
        .then(response => response.json())
        .then(data => {
          allStations = data.stations;
          currentPage = 0;
          clearStationMarkers();
          // Für jede gefundene Station: Marker hinzufügen, Popup mit Stationdaten
          allStations.forEach(station => {
            var marker = L.marker([station.latitude, station.longitude], {icon: blueIcon})
              .bindPopup(`<b>${station.name}</b><br>${station.latitude}, ${station.longitude}`);
            marker.addTo(map);
            stationMarkers.push(marker);
          });
          // Aktuellen Standortmarker setzen, alte entfernen
          if(currentLocationMarker) { map.removeLayer(currentLocationMarker); }
          currentLocationMarker = L.marker([latitude, longitude], {icon: redIcon})
            .bindPopup("Ihre Position")
            .addTo(map);
          map.setView([latitude, longitude], 10);
          displayStationPage(); // Paginierte Stationenliste anzeigen
        })
        .catch(err => console.error(err));
    });

    // Pagination: Vorherige Seite, Seite verringern, Stationenliste neu anzeigen
    document.getElementById('prev-button').addEventListener('click', function() {
      if (currentPage > 0) {
        currentPage--;
        displayStationPage();
      }
    });

    // Pagination: Nächste Seite, Seite erhöhen, Stationenliste neu anzeigen
    document.getElementById('next-button').addEventListener('click', function() {
      if ((currentPage + 1) * pageSize < allStations.length) {
        currentPage++;
        displayStationPage();
      }
    });

    // Funktionen für Checkbox-Steuerung:
    // toggleMinMax: Zeigt oder versteckt die Min/Max-Werte in den Zellen, passt Dotted-Line an
    function toggleMinMax(type, checkbox) {
      const minElements = document.querySelectorAll('.data-min');
      const maxElements = document.querySelectorAll('.data-max');
      const dottedLines = document.querySelectorAll('.dotted-line');
      if (type === 'min') {
        minElements.forEach(el => el.classList.toggle('hidden', !checkbox.checked));
      } else if (type === 'max') {
        maxElements.forEach(el => el.classList.toggle('hidden', !checkbox.checked));
      }
      dottedLines.forEach(line => {
        const parentCell = line.closest('td');
        if (!parentCell) return;
        const minVisible = parentCell.querySelector('.data-min:not(.hidden)');
        const maxVisible = parentCell.querySelector('.data-max:not(.hidden)');
        line.classList.toggle('hidden', !(minVisible && maxVisible));
      });
    }
    // toggleColumn: Zeigt oder versteckt ganze Spalten (z.B. annual, seasonal), basierend auf Checkbox-Status
    function toggleColumn(columnClass, checkbox) {
      const elements = document.querySelectorAll(`.column-${columnClass}`);
      elements.forEach(el => el.classList.toggle('hidden', !checkbox.checked));
    }
  </script>
</body>
</html>
